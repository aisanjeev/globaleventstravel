---
import MainLayout from '@/layouts/MainLayout.astro';
import HeroHome from '@/components/hero/HeroHome.astro';
import FeaturedTreks from '@/components/sections/FeaturedTreks.astro';
import BudgetTreks from '@/components/sections/BudgetTreks.astro';
import WhyChooseUs from '@/components/sections/WhyChooseUs.astro';
import PopularDestinations from '@/components/sections/PopularDestinations.astro';
import GoogleReviews from '@/components/sections/GoogleReviews';
import ExpeditionList from '@/components/expedition/ExpeditionList.astro';
import CTA from '@/components/sections/CTA.astro';

import { treksApi, expeditionsApi, api } from '@/lib/api';

// Enable SSR for dynamic data fetching
export const prerender = false;

// Fetch featured treks from API only (no mock fallback)
let featuredTreks = [];
try {
  featuredTreks = await treksApi.getFeatured(6);
} catch (error) {
  console.error('Failed to fetch featured treks from API:', error);
}

// Fetch expeditions from API for home page (no mock fallback)
let homeExpeditions = [];
try {
  const expRes = await expeditionsApi.list({ status: 'published', limit: 2 });
  homeExpeditions = expRes.items || [];
} catch (error) {
  console.error('Failed to fetch expeditions from API:', error);
}

// Fetch budget treks (max price 10000)
let budgetTreks = [];
try {
  const budgetRes = await treksApi.list({ maxPrice: 10000, limit: 4 });
  budgetTreks = budgetRes.items || [];
} catch (error) {
  console.error('Failed to fetch budget treks:', error);
}

// Fetch page content for featured_defaults (urgency text)
let featuredDefaults: { nextBatch?: string; seatsText?: string } | undefined;
try {
  const fdSection = await api.get<{ body_html?: string | null }>('/content/home/featured_defaults');
  if (fdSection?.body_html) {
    featuredDefaults = JSON.parse(fdSection.body_html) as { nextBatch?: string; seatsText?: string };
  }
} catch (error) {
  // Section may not exist yet; ignore
}

// Fetch expeditions section content
let expeditionsContent: { title?: string; subtitle?: string } = {};
try {
  const expSection = await api.get<{ title?: string | null; subtitle?: string | null }>('/content/home/expeditions');
  if (expSection?.title) expeditionsContent.title = expSection.title;
  if (expSection?.subtitle) expeditionsContent.subtitle = expSection.subtitle;
} catch (error) {
  // Use defaults
}
---

<MainLayout title="Home" description="Discover amazing treks and expeditions in the Himalayas with Global Events Travels. Expert guides, safety first, unforgettable experiences.">
  
  <!-- Hero Section -->
  <HeroHome />

  <!-- Featured Treks -->
  <FeaturedTreks treks={featuredTreks} urgencyDefaults={featuredDefaults} />

  <!-- Budget Treks -->
  <BudgetTreks treks={budgetTreks} />

  <!-- Why Choose Us -->
  <WhyChooseUs />

  <!-- Popular Destinations -->
  <PopularDestinations />

  <!-- Expeditions Section (compact on homepage) -->
  <ExpeditionList expeditions={homeExpeditions} showTitle={true} compact={true} title={expeditionsContent.title} subtitle={expeditionsContent.subtitle} />

  <!-- Google Reviews (replaces testimonials) -->
  <GoogleReviews client:visible />

  <!-- CTA Section -->
  <CTA />

</MainLayout>
