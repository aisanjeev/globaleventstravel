---
import MainLayout from '@/layouts/MainLayout.astro';
import TrekGrid from '@/components/trek/TrekGrid.astro';
import TrekTrendingRow from '@/components/trek/TrekTrendingRow.astro';
import WhyChooseUs from '@/components/sections/WhyChooseUs.astro';
import GoogleReviews from '@/components/sections/GoogleReviews';
import { DIFFICULTY_LABELS } from '@/lib/constants';

// Region slug -> image mapping (fallback for derived regions)
const REGION_IMAGE_MAP: Record<string, string> = {
  'Uttarakhand': '/images/destinations/uttarakhand.jpg',
  'Himachal Pradesh': '/images/destinations/himachal.jpg',
  'Himachal': '/images/destinations/himachal.jpg',
  'Kashmir': '/images/destinations/srinagar.jpg',
  'Sikkim': '/images/destinations/himachal.jpg',
};

// Enable SSR for this page - allows dynamic filtering via URL params
export const prerender = false;

// Pagination configuration
const ITEMS_PER_PAGE = 9;
const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';

// Get page from URL params
const url = Astro.url;
const currentPage = Math.max(1, parseInt(url.searchParams.get('page') || '1'));
const difficulty = url.searchParams.get('difficulty') || undefined;
const season = url.searchParams.get('season') || undefined;
const maxPrice = url.searchParams.get('max_price') || undefined;
const location = url.searchParams.get('location') || undefined;
const sort = url.searchParams.get('sort') || undefined;

// Build API URL with filters
const apiParams = new URLSearchParams();
apiParams.set('skip', String((currentPage - 1) * ITEMS_PER_PAGE));
apiParams.set('limit', String(ITEMS_PER_PAGE));
apiParams.set('status', 'published');
if (difficulty) apiParams.set('difficulty', difficulty);
if (season) apiParams.set('season', season);
if (maxPrice) apiParams.set('max_price', maxPrice);
if (location) apiParams.set('location', location);
if (sort) apiParams.set('sort', sort);

// Fetch treks from backend API
let treks: any[] = [];
let totalItems = 0;
let totalPages = 1;
let allSeasons: string[] = [];
let allTreks: any[] = [];
let derivedRegions: { name: string; slug: string; image: string; count: number }[] = [];
let budgetTiers: { label: string; value: string }[] = [];
let popularChips: { label: string; href: string }[] = [];

try {
  const response = await fetch(`${API_BASE_URL}/api/v1/treks?${apiParams.toString()}`);
  if (response.ok) {
    const data = await response.json();
    treks = data.items || [];
    totalItems = data.total || 0;
    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
  }
  
  // Fetch all treks for filters, regions, budget tiers, popular chips
  const allTreksResponse = await fetch(`${API_BASE_URL}/api/v1/treks?limit=100&status=published`);
  if (allTreksResponse.ok) {
    const allData = await allTreksResponse.json();
    allTreks = allData.items || [];
    allSeasons = [...new Set(allTreks.flatMap((t: any) => t.best_season || []))].sort() as string[];

    // Derive regions from unique location values (extract state/region part after comma)
    const locationCounts: Record<string, number> = {};
    for (const t of allTreks) {
      const loc = (t.location || '').trim();
      if (!loc) continue;
      // Use full location, or last part after comma as region (e.g. "Uttarkashi, Uttarakhand" -> "Uttarakhand")
      const regionName = loc.includes(',') ? loc.split(',').pop()!.trim() : loc;
      locationCounts[regionName] = (locationCounts[regionName] || 0) + 1;
    }
    derivedRegions = Object.entries(locationCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 6)
      .map(([name, count]) => ({
        name,
        slug: name,
        image: REGION_IMAGE_MAP[name] || REGION_IMAGE_MAP[name.split(' ')[0]] || '/images/destinations/uttarakhand.jpg',
        count,
      }));

    // Derive budget tiers from max trek price
    const prices = allTreks.map((t: any) => t.price || 0).filter((p: number) => p > 0);
    const maxP = prices.length ? Math.max(...prices) : 50000;
    const defaultTiers = [10000, 20000, 30000, 50000];
    const relevantTiers = defaultTiers.filter((v) => v <= Math.max(maxP, 50000));
    budgetTiers = [
      { label: 'Any', value: '' },
      ...(relevantTiers.length > 0 ? relevantTiers : [Math.ceil(maxP / 10000) * 10000 || 20000]).map((v: number) => ({
        label: `Under ₹${(v / 1000).toFixed(0)}K`,
        value: String(v),
      })),
    ];

    // Build popular chips from most common filters
    const topRegions = derivedRegions.slice(0, 2);
    const easyCount = allTreks.filter((t: any) => t.difficulty === 'easy').length;
    const winterSeason = allSeasons.find((s) => /dec|jan|feb/i.test(s));
    popularChips = [
      ...(topRegions.map((r) => ({ label: r.name, href: `/treks?location=${encodeURIComponent(r.slug)}&page=1` }))),
      ...(easyCount > 0 ? [{ label: 'Beginner Friendly', href: '/treks?difficulty=easy&page=1' }] : []),
      ...(budgetTiers.find((b) => b.value === '10000') ? [{ label: 'Under ₹10K', href: '/treks?max_price=10000&page=1' }] : []),
      ...(winterSeason ? [{ label: 'Winter Treks', href: `/treks?season=${encodeURIComponent(winterSeason)}&page=1` }] : []),
    ].slice(0, 5);
  }
} catch (error) {
  console.error('Failed to fetch treks:', error);
}

// Fallbacks when no data
if (derivedRegions.length === 0) {
  derivedRegions = [
    { name: 'Uttarakhand', slug: 'Uttarakhand', image: '/images/destinations/uttarakhand.jpg', count: 0 },
    { name: 'Himachal Pradesh', slug: 'Himachal', image: '/images/destinations/himachal.jpg', count: 0 },
  ];
}
if (budgetTiers.length <= 1) {
  budgetTiers = [
    { label: 'Any', value: '' },
    { label: 'Under ₹10K', value: '10000' },
    { label: 'Under ₹20K', value: '20000' },
    { label: 'Under ₹30K', value: '30000' },
    { label: 'Under ₹50K', value: '50000' },
  ];
}
if (popularChips.length === 0) {
  popularChips = [
    { label: 'Winter Treks', href: '/treks?season=Dec&page=1' },
    { label: 'Beginner Friendly', href: '/treks?difficulty=easy&page=1' },
    { label: 'Under ₹10K', href: '/treks?max_price=10000&page=1' },
    { label: 'Uttarakhand', href: '/treks?location=Uttarakhand&page=1' },
  ];
}

// Calculate pagination range
const getPageNumbers = () => {
  const pages: (number | string)[] = [];
  const showPages = 5; // Number of page buttons to show
  
  if (totalPages <= showPages) {
    for (let i = 1; i <= totalPages; i++) {
      pages.push(i);
    }
  } else {
    // Always show first page
    pages.push(1);
    
    // Calculate start and end of middle pages
    let start = Math.max(2, currentPage - 1);
    let end = Math.min(totalPages - 1, currentPage + 1);
    
    // Adjust if at the beginning or end
    if (currentPage <= 3) {
      end = Math.min(4, totalPages - 1);
    } else if (currentPage >= totalPages - 2) {
      start = Math.max(2, totalPages - 3);
    }
    
    // Add ellipsis if needed
    if (start > 2) pages.push('...');
    
    // Add middle pages
    for (let i = start; i <= end; i++) {
      pages.push(i);
    }
    
    // Add ellipsis if needed
    if (end < totalPages - 1) pages.push('...');
    
    // Always show last page
    if (totalPages > 1) pages.push(totalPages);
  }
  
  return pages;
};

// Build URL with current filters for pagination links
const buildPageUrl = (page: number) => {
  const params = new URLSearchParams();
  params.set('page', String(page));
  if (difficulty) params.set('difficulty', difficulty);
  if (season) params.set('season', season);
  if (maxPrice) params.set('max_price', maxPrice);
  if (location) params.set('location', location);
  if (sort) params.set('sort', sort);
  return `/treks?${params.toString()}`;
};

// Build filter URL (resets to page 1)
const buildFilterUrl = (filters: Record<string, string | undefined>) => {
  const params = new URLSearchParams();
  params.set('page', '1');
  const allFilters = { difficulty, season, max_price: maxPrice, location, sort, ...filters };
  Object.entries(allFilters).forEach(([key, value]) => {
    if (value) params.set(key, value);
  });
  return `/treks?${params.toString()}`;
};

// Fetch featured treks for trending section
let featuredTreks: any[] = [];
try {
  const featuredResponse = await fetch(`${API_BASE_URL}/api/v1/treks/featured?limit=6`);
  if (featuredResponse.ok) {
    featuredTreks = await featuredResponse.json();
  }
} catch (error) {
  console.error('Failed to fetch featured treks:', error);
}

const pageNumbers = getPageNumbers();
const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
---

<MainLayout 
  title="All Treks" 
  description="Browse our complete collection of Himalayan treks. Filter by difficulty, price, and season to find your perfect adventure."
>
  <!-- Cinematic Hero -->
  <section class="relative min-h-[50vh] flex items-center">
    <div 
      class="absolute inset-0 bg-cover bg-center bg-no-repeat" 
      style="background-image: url('/images/home/hero-bg.webp')"
      aria-hidden="true"
    ></div>
    <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-black/40 to-black/70"></div>
    <div class="relative z-10 container-custom w-full py-16 md:py-24">
      <div class="text-center text-white max-w-3xl mx-auto">
        <h1 class="text-4xl md:text-5xl lg:text-6xl font-bold mb-4 text-white">Find Your Next Himalayan Adventure</h1>
        <p class="text-lg md:text-xl text-white/90">
          From beginner-friendly snow treks to extreme summit expeditions.
        </p>
      </div>
    </div>
  </section>

  <!-- Smart Search Bar -->
  <section class="relative z-20 -mt-12">
    <div class="container-custom">
      <div class="bg-white rounded-2xl shadow-xl border border-neutral-200 p-6 md:p-8">
        <form 
          action="/treks" 
          method="get" 
          class="flex flex-col lg:flex-row gap-4 items-end"
        >
          <input type="hidden" name="page" value="1" />
          <div class="flex-1 w-full">
            <label for="location" class="block text-sm font-medium text-neutral-700 mb-1">Where do you want to trek?</label>
            <select 
              id="location" 
              name="location" 
              class="w-full px-4 py-3 border border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">All Regions</option>
              {derivedRegions.map((r) => (
                <option value={r.slug} {...(location === r.slug ? { selected: true } : {})}>{r.name}</option>
              ))}
            </select>
          </div>
          <div class="w-full lg:w-48">
            <label for="difficulty" class="block text-sm font-medium text-neutral-700 mb-1">Difficulty</label>
            <select 
              id="difficulty" 
              name="difficulty" 
              class="w-full px-4 py-3 border border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              <option value="">Any</option>
              {Object.entries(DIFFICULTY_LABELS).map(([key, val]) => (
                <option value={key} {...(difficulty === key ? { selected: true } : {})}>{val.label}</option>
              ))}
            </select>
          </div>
          <div class="w-full lg:w-48">
            <label for="max_price" class="block text-sm font-medium text-neutral-700 mb-1">Budget</label>
            <select 
              id="max_price" 
              name="max_price" 
              class="w-full px-4 py-3 border border-neutral-200 rounded-xl focus:ring-2 focus:ring-primary-500 focus:border-primary-500"
            >
              {budgetTiers.map((tier) => (
                <option value={tier.value} {...(maxPrice === tier.value ? { selected: true } : {})}>{tier.label}</option>
              ))}
            </select>
          </div>
          <button 
            type="submit" 
            class="w-full lg:w-auto px-8 py-3 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-xl transition-colors flex items-center justify-center gap-2"
          >
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            Search
          </button>
        </form>
        <!-- Popular search chips (derived from trek data) -->
        <div class="mt-6 pt-6 border-t border-neutral-100">
          <p class="text-sm text-neutral-500 mb-3">Popular searches</p>
          <div class="flex flex-wrap gap-2">
            {popularChips.map((chip) => (
              <a href={chip.href} class="px-4 py-2 bg-neutral-100 hover:bg-primary-50 text-neutral-700 hover:text-primary-700 rounded-full text-sm font-medium transition-colors">{chip.label}</a>
            ))}
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Trending Treks Section -->
  {featuredTreks.length > 0 && (
    <section class="section bg-white">
      <div class="container-custom">
        <div class="mb-8">
          <span class="inline-block text-primary-500 font-semibold text-sm uppercase tracking-wider mb-2">Trending This Season</span>
          <h2 class="text-2xl md:text-3xl font-bold text-secondary-600">Featured Treks</h2>
        </div>
        <TrekTrendingRow treks={featuredTreks} />
      </div>
    </section>
  )}

  <!-- Main Content -->
  <section class="section bg-neutral-50">
    <div class="container-custom">
      <div class="lg:flex lg:gap-8">
        
        <!-- Filters Sidebar -->
        <aside class="lg:w-72 flex-shrink-0 mb-8 lg:mb-0">
          <div class="bg-white rounded-xl border border-neutral-200 p-6 sticky top-24">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-secondary-600 flex items-center gap-2">
                <svg class="w-5 h-5 text-primary-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z" />
                </svg>
                Filters
              </h3>
              <a href="/treks" class="text-sm text-primary-500 hover:text-primary-600 font-medium">
                Reset
              </a>
            </div>

            <!-- Difficulty Filter (Collapsible) -->
            <details class="group mb-4" open>
              <summary class="flex items-center gap-2 font-medium text-neutral-800 cursor-pointer list-none py-2 hover:text-secondary-600">
                <svg class="w-5 h-5 text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                Difficulty
                <svg class="w-4 h-4 ml-auto transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="mt-3 space-y-2 pl-7">
                {Object.entries(DIFFICULTY_LABELS).map(([key, value]) => (
                  <a 
                    href={buildFilterUrl({ difficulty: difficulty === key ? undefined : key })}
                    class={`flex items-center gap-3 cursor-pointer group-item px-2 py-1.5 rounded-lg transition-colors ${difficulty === key ? 'bg-primary-50' : 'hover:bg-neutral-50'}`}
                  >
                    <span class={`badge ${value.color} text-xs`}>{value.label}</span>
                  </a>
                ))}
              </div>
            </details>

            <!-- Price Range Filter (Collapsible) -->
            <details class="group mb-4" open>
              <summary class="flex items-center gap-2 font-medium text-neutral-800 cursor-pointer list-none py-2 hover:text-secondary-600">
                <svg class="w-5 h-5 text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Budget
                <svg class="w-4 h-4 ml-auto transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </summary>
              <div class="mt-3 space-y-2 pl-7">
                {budgetTiers.filter((t) => t.value).map((tier) => (
                  <a 
                    href={buildFilterUrl({ max_price: maxPrice === tier.value ? undefined : tier.value })}
                    class={`flex items-center gap-3 cursor-pointer group-item px-2 py-1.5 rounded-lg transition-colors ${maxPrice === tier.value ? 'bg-primary-50 text-primary-700' : 'hover:bg-neutral-50'}`}
                  >
                    <span class={`w-4 h-4 rounded-full border-2 flex items-center justify-center flex-shrink-0 ${maxPrice === tier.value ? 'border-primary-500' : 'border-neutral-300'}`}>
                      {maxPrice === tier.value && (
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                      )}
                    </span>
                    <span class="text-neutral-600 group-hover:text-secondary-600">{tier.label}</span>
                  </a>
                ))}
              </div>
            </details>

            <!-- Season Filter (Collapsible) -->
            {allSeasons.length > 0 && (
              <details class="group mb-4" open>
                <summary class="flex items-center gap-2 font-medium text-neutral-800 cursor-pointer list-none py-2 hover:text-secondary-600">
                  <svg class="w-5 h-5 text-primary-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                  Season
                  <svg class="w-4 h-4 ml-auto transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <div class="mt-3 grid grid-cols-2 gap-2 pl-7">
                  {allSeasons.slice(0, 6).map((s) => (
                    <a 
                      href={buildFilterUrl({ season: season === s ? undefined : s })}
                      class={`flex items-center gap-2 cursor-pointer group-item px-2 py-1.5 rounded-lg transition-colors ${season === s ? 'bg-primary-50 text-primary-700' : 'hover:bg-neutral-50'}`}
                    >
                      <span class={`w-4 h-4 rounded border-2 flex items-center justify-center flex-shrink-0 ${season === s ? 'border-primary-500 bg-primary-500' : 'border-neutral-300'}`}>
                        {season === s && (
                          <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                          </svg>
                        )}
                      </span>
                      <span class="text-sm text-neutral-600 group-hover:text-secondary-600 truncate">{s}</span>
                    </a>
                  ))}
                </div>
              </details>
            )}
          </div>
        </aside>

        <!-- Trek Grid -->
        <div class="flex-grow">
          <!-- Results Header + Sort -->
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
            <p class="text-neutral-600">
              {totalItems > 0 ? (
                <>
                  Showing <span class="font-semibold text-secondary-600">{startItem}-{endItem}</span> of <span class="font-semibold text-secondary-600">{totalItems}</span> treks
                </>
              ) : (
                <span>No treks found</span>
              )}
            </p>
            <div class="flex items-center gap-2">
              <label for="sort-treks" class="text-sm text-neutral-600">Sort by</label>
              <select 
                id="sort-treks" 
                class="px-3 py-2 border border-neutral-200 rounded-lg text-sm bg-white focus:border-primary-500 focus:ring-1 focus:ring-primary-500"
                onchange="window.location.href = this.value"
              >
                <option value={buildFilterUrl({ sort: 'newest' })} selected={sort === 'newest' || !sort}>Newest</option>
                <option value={buildFilterUrl({ sort: 'popularity' })} selected={sort === 'popularity'}>Popularity</option>
                <option value={buildFilterUrl({ sort: 'price_asc' })} selected={sort === 'price_asc'}>Price (Low to High)</option>
                <option value={buildFilterUrl({ sort: 'price_desc' })} selected={sort === 'price_desc'}>Price (High to Low)</option>
                <option value={buildFilterUrl({ sort: 'rating' })} selected={sort === 'rating'}>Rating</option>
              </select>
            </div>
          </div>

          <!-- Trek Cards Grid -->
          <TrekGrid treks={treks} columns={3} />

          <!-- Pagination -->
          {totalPages > 1 && (
            <div class="mt-12 flex justify-center">
              <nav class="flex items-center gap-2" aria-label="Pagination">
                <!-- Previous Button -->
                {currentPage > 1 ? (
                  <a 
                    href={buildPageUrl(currentPage - 1)}
                    class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                  >
                    Previous
                  </a>
                ) : (
                  <span class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-400 cursor-not-allowed">
                    Previous
                  </span>
                )}

                <!-- Page Numbers -->
                {pageNumbers.map((page) => (
                  page === '...' ? (
                    <span class="px-3 py-2 text-neutral-400">...</span>
                  ) : page === currentPage ? (
                    <span class="px-4 py-2 rounded-lg bg-primary-500 text-white font-medium">
                      {page}
                    </span>
                  ) : (
                    <a 
                      href={buildPageUrl(page as number)}
                      class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                    >
                      {page}
                    </a>
                  )
                ))}

                <!-- Next Button -->
                {currentPage < totalPages ? (
                  <a 
                    href={buildPageUrl(currentPage + 1)}
                    class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                  >
                    Next
                  </a>
                ) : (
                  <span class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-400 cursor-not-allowed">
                    Next
                  </span>
                )}
              </nav>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>

  <!-- Explore by Region -->
  <section class="section bg-white">
    <div class="container-custom">
      <div class="text-center mb-10">
        <span class="inline-block text-primary-500 font-semibold text-sm uppercase tracking-wider mb-2">Discover</span>
        <h2 class="text-3xl md:text-4xl font-bold text-secondary-600">Explore by Region</h2>
      </div>
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
        {derivedRegions.map((region) => (
          <a 
            href={`/treks?location=${encodeURIComponent(region.slug)}&page=1`}
            class="group relative aspect-[4/3] rounded-xl overflow-hidden block"
          >
            <img 
              src={region.image} 
              alt={region.name}
              class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500"
              loading="lazy"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"></div>
            <div class="absolute bottom-0 left-0 right-0 p-4">
              <h3 class="text-lg font-bold text-white">{region.name}</h3>
              <span class="text-white/90 text-sm flex items-center gap-1">
                {region.count > 0 ? `${region.count} trek${region.count !== 1 ? 's' : ''} · Explore` : 'Explore treks'}
                <svg class="w-4 h-4 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- Why Trek With Us -->
  <WhyChooseUs />

  <!-- Google Reviews (What Our Trekkers Say - same as home page) -->
  <GoogleReviews client:visible />

  <!-- FAQ Section -->
  <section class="section bg-neutral-50">
    <div class="container-custom max-w-3xl">
      <div class="text-center mb-10">
        <span class="inline-block text-primary-500 font-semibold text-sm uppercase tracking-wider mb-2">Help</span>
        <h2 class="text-3xl md:text-4xl font-bold text-secondary-600">Frequently Asked Questions</h2>
      </div>
      <div class="space-y-4">
        <details class="bg-white rounded-xl border border-neutral-200 overflow-hidden group">
          <summary class="px-6 py-4 font-semibold text-neutral-900 cursor-pointer list-none flex items-center justify-between">
            How do I book a trek?
            <svg class="w-5 h-5 text-neutral-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="px-6 pb-4 text-neutral-600">
            Click on any trek to view details, then fill the enquiry form or WhatsApp us. We'll confirm availability and share the booking process.
          </div>
        </details>
        <details class="bg-white rounded-xl border border-neutral-200 overflow-hidden group">
          <summary class="px-6 py-4 font-semibold text-neutral-900 cursor-pointer list-none flex items-center justify-between">
            What difficulty level should I choose?
            <svg class="w-5 h-5 text-neutral-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="px-6 pb-4 text-neutral-600">
            Easy treks suit first-timers. Moderate requires basic fitness. Difficult and above need prior trekking experience. Check each trek's fitness requirements.
          </div>
        </details>
        <details class="bg-white rounded-xl border border-neutral-200 overflow-hidden group">
          <summary class="px-6 py-4 font-semibold text-neutral-900 cursor-pointer list-none flex items-center justify-between">
            When is the best season to trek?
            <svg class="w-5 h-5 text-neutral-500 transition-transform group-open:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </summary>
          <div class="px-6 pb-4 text-neutral-600">
            Depends on the trek. Winter treks (Dec-Feb) offer snow. Summer (April-June) is ideal for most Himalayan treks. Monsoon (July-Sept) is good for Valley of Flowers.
          </div>
        </details>
      </div>
    </div>
  </section>

  <!-- Final CTA Banner -->
  <section class="bg-white py-16 border-t border-neutral-200">
    <div class="container-custom text-center">
      <h2 class="text-3xl md:text-4xl font-bold text-neutral-900 mb-4">Ready for Your Next Adventure?</h2>
      <p class="text-lg text-neutral-600 max-w-xl mx-auto mb-8">
        Get your free personalized trek itinerary sent to WhatsApp. No spam, just your perfect adventure plan.
      </p>
      <a 
        href="/#lead-form" 
        class="inline-flex items-center gap-2 px-8 py-4 bg-primary-500 hover:bg-primary-600 text-white font-semibold rounded-xl shadow-lg transition-colors"
      >
        Get Free Itinerary
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
        </svg>
      </a>
    </div>
  </section>
</MainLayout>
