---
import MainLayout from '@/layouts/MainLayout.astro';
import TrekGrid from '@/components/trek/TrekGrid.astro';
import { DIFFICULTY_LABELS } from '@/lib/constants';

// Enable SSR for this page - allows dynamic filtering via URL params
export const prerender = false;

// Pagination configuration
const ITEMS_PER_PAGE = 9;
const API_BASE_URL = import.meta.env.PUBLIC_API_URL || 'http://localhost:8000';

// Get page from URL params
const url = Astro.url;
const currentPage = Math.max(1, parseInt(url.searchParams.get('page') || '1'));
const difficulty = url.searchParams.get('difficulty') || undefined;
const season = url.searchParams.get('season') || undefined;
const maxPrice = url.searchParams.get('max_price') || undefined;

// Build API URL with filters
const apiParams = new URLSearchParams();
apiParams.set('skip', String((currentPage - 1) * ITEMS_PER_PAGE));
apiParams.set('limit', String(ITEMS_PER_PAGE));
if (difficulty) apiParams.set('difficulty', difficulty);
if (season) apiParams.set('season', season);
if (maxPrice) apiParams.set('max_price', maxPrice);

// Fetch treks from backend API
let treks: any[] = [];
let totalItems = 0;
let totalPages = 1;
let allSeasons: string[] = [];

try {
  const response = await fetch(`${API_BASE_URL}/api/v1/treks?${apiParams.toString()}`);
  if (response.ok) {
    const data = await response.json();
    treks = data.items || [];
    totalItems = data.total || 0;
    totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
  }
  
  // Fetch all treks to get unique seasons (for filter options)
  const allTreksResponse = await fetch(`${API_BASE_URL}/api/v1/treks?limit=100`);
  if (allTreksResponse.ok) {
    const allData = await allTreksResponse.json();
    const allTreks = allData.items || [];
    allSeasons = [...new Set(allTreks.flatMap((trek: any) => trek.best_season || []))].sort() as string[];
  }
} catch (error) {
  console.error('Failed to fetch treks:', error);
}

// Calculate pagination range
const getPageNumbers = () => {
  const pages: (number | string)[] = [];
  const showPages = 5; // Number of page buttons to show
  
  if (totalPages <= showPages) {
    for (let i = 1; i <= totalPages; i++) {
      pages.push(i);
    }
  } else {
    // Always show first page
    pages.push(1);
    
    // Calculate start and end of middle pages
    let start = Math.max(2, currentPage - 1);
    let end = Math.min(totalPages - 1, currentPage + 1);
    
    // Adjust if at the beginning or end
    if (currentPage <= 3) {
      end = Math.min(4, totalPages - 1);
    } else if (currentPage >= totalPages - 2) {
      start = Math.max(2, totalPages - 3);
    }
    
    // Add ellipsis if needed
    if (start > 2) pages.push('...');
    
    // Add middle pages
    for (let i = start; i <= end; i++) {
      pages.push(i);
    }
    
    // Add ellipsis if needed
    if (end < totalPages - 1) pages.push('...');
    
    // Always show last page
    if (totalPages > 1) pages.push(totalPages);
  }
  
  return pages;
};

// Build URL with current filters for pagination links
const buildPageUrl = (page: number) => {
  const params = new URLSearchParams();
  params.set('page', String(page));
  if (difficulty) params.set('difficulty', difficulty);
  if (season) params.set('season', season);
  if (maxPrice) params.set('max_price', maxPrice);
  return `/treks?${params.toString()}`;
};

// Build filter URL (resets to page 1)
const buildFilterUrl = (filters: Record<string, string | undefined>) => {
  const params = new URLSearchParams();
  params.set('page', '1');
  Object.entries(filters).forEach(([key, value]) => {
    if (value) params.set(key, value);
  });
  return `/treks?${params.toString()}`;
};

const pageNumbers = getPageNumbers();
const startItem = (currentPage - 1) * ITEMS_PER_PAGE + 1;
const endItem = Math.min(currentPage * ITEMS_PER_PAGE, totalItems);
---

<MainLayout 
  title="All Treks" 
  description="Browse our complete collection of Himalayan treks. Filter by difficulty, price, and season to find your perfect adventure."
>
  <!-- Page Header - Blue theme -->
  <section class="bg-gradient-to-br from-secondary-600 to-secondary-500 py-16 md:py-24">
    <div class="container-custom text-center text-white">
      <h1 class="text-4xl md:text-5xl font-bold mb-4 text-white">Explore Our Treks</h1>
      <p class="text-lg text-white/80 max-w-2xl mx-auto">
        From easy weekend getaways to challenging high-altitude expeditions, find the perfect trek for your next adventure.
      </p>
    </div>
  </section>

  <!-- Main Content -->
  <section class="section bg-neutral-50">
    <div class="container-custom">
      <div class="lg:flex lg:gap-8">
        
        <!-- Filters Sidebar -->
        <aside class="lg:w-72 flex-shrink-0 mb-8 lg:mb-0">
          <div class="bg-white rounded-xl border border-neutral-200 p-6 sticky top-24">
            <div class="flex items-center justify-between mb-6">
              <h3 class="text-lg font-semibold text-secondary-600">Filters</h3>
              <a href="/treks" class="text-sm text-primary-500 hover:text-primary-600 font-medium">
                Reset
              </a>
            </div>

            <!-- Difficulty Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-neutral-800 mb-3">Difficulty</h4>
              <div class="space-y-2">
                {Object.entries(DIFFICULTY_LABELS).map(([key, value]) => (
                  <a 
                    href={buildFilterUrl({ difficulty: difficulty === key ? undefined : key, season, max_price: maxPrice })}
                    class={`flex items-center gap-3 cursor-pointer group px-2 py-1.5 rounded-lg transition-colors ${difficulty === key ? 'bg-primary-50 text-primary-700' : 'hover:bg-neutral-50'}`}
                  >
                    <span class={`w-4 h-4 rounded border-2 flex items-center justify-center ${difficulty === key ? 'border-primary-500 bg-primary-500' : 'border-neutral-300'}`}>
                      {difficulty === key && (
                        <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                        </svg>
                      )}
                    </span>
                    <span class="text-neutral-600 group-hover:text-secondary-600">{value.label}</span>
                  </a>
                ))}
              </div>
            </div>

            <!-- Price Range Filter -->
            <div class="mb-6">
              <h4 class="font-medium text-neutral-800 mb-3">Max Price</h4>
              <div class="space-y-2">
                {[
                  { label: 'Under ₹10,000', value: '10000' },
                  { label: 'Under ₹20,000', value: '20000' },
                  { label: 'Under ₹30,000', value: '30000' },
                  { label: 'Under ₹50,000', value: '50000' },
                ].map((price) => (
                  <a 
                    href={buildFilterUrl({ difficulty, season, max_price: maxPrice === price.value ? undefined : price.value })}
                    class={`flex items-center gap-3 cursor-pointer group px-2 py-1.5 rounded-lg transition-colors ${maxPrice === price.value ? 'bg-primary-50 text-primary-700' : 'hover:bg-neutral-50'}`}
                  >
                    <span class={`w-4 h-4 rounded-full border-2 flex items-center justify-center ${maxPrice === price.value ? 'border-primary-500' : 'border-neutral-300'}`}>
                      {maxPrice === price.value && (
                        <span class="w-2 h-2 rounded-full bg-primary-500"></span>
                      )}
                    </span>
                    <span class="text-neutral-600 group-hover:text-secondary-600">{price.label}</span>
                  </a>
                ))}
              </div>
            </div>

            <!-- Season Filter -->
            {allSeasons.length > 0 && (
              <div class="mb-6">
                <h4 class="font-medium text-neutral-800 mb-3">Season</h4>
                <div class="grid grid-cols-2 gap-2">
                  {allSeasons.slice(0, 6).map((s) => (
                    <a 
                      href={buildFilterUrl({ difficulty, season: season === s ? undefined : s, max_price: maxPrice })}
                      class={`flex items-center gap-2 cursor-pointer group px-2 py-1.5 rounded-lg transition-colors ${season === s ? 'bg-primary-50 text-primary-700' : 'hover:bg-neutral-50'}`}
                    >
                      <span class={`w-4 h-4 rounded border-2 flex items-center justify-center ${season === s ? 'border-primary-500 bg-primary-500' : 'border-neutral-300'}`}>
                        {season === s && (
                          <svg class="w-3 h-3 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
                          </svg>
                        )}
                      </span>
                      <span class="text-sm text-neutral-600 group-hover:text-secondary-600">{s}</span>
                    </a>
                  ))}
                </div>
              </div>
            )}
          </div>
        </aside>

        <!-- Trek Grid -->
        <div class="flex-grow">
          <!-- Results Header -->
          <div class="flex items-center justify-between mb-6">
            <p class="text-neutral-600">
              {totalItems > 0 ? (
                <>
                  Showing <span class="font-semibold text-secondary-600">{startItem}-{endItem}</span> of <span class="font-semibold text-secondary-600">{totalItems}</span> treks
                </>
              ) : (
                <span>No treks found</span>
              )}
            </p>
          </div>

          <!-- Trek Cards Grid -->
          <TrekGrid treks={treks} columns={3} />

          <!-- Pagination -->
          {totalPages > 1 && (
            <div class="mt-12 flex justify-center">
              <nav class="flex items-center gap-2" aria-label="Pagination">
                <!-- Previous Button -->
                {currentPage > 1 ? (
                  <a 
                    href={buildPageUrl(currentPage - 1)}
                    class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                  >
                    Previous
                  </a>
                ) : (
                  <span class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-400 cursor-not-allowed">
                    Previous
                  </span>
                )}

                <!-- Page Numbers -->
                {pageNumbers.map((page) => (
                  page === '...' ? (
                    <span class="px-3 py-2 text-neutral-400">...</span>
                  ) : page === currentPage ? (
                    <span class="px-4 py-2 rounded-lg bg-primary-500 text-white font-medium">
                      {page}
                    </span>
                  ) : (
                    <a 
                      href={buildPageUrl(page as number)}
                      class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                    >
                      {page}
                    </a>
                  )
                ))}

                <!-- Next Button -->
                {currentPage < totalPages ? (
                  <a 
                    href={buildPageUrl(currentPage + 1)}
                    class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-600 hover:bg-neutral-50 transition-colors"
                  >
                    Next
                  </a>
                ) : (
                  <span class="px-4 py-2 rounded-lg border border-neutral-200 text-neutral-400 cursor-not-allowed">
                    Next
                  </span>
                )}
              </nav>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</MainLayout>
