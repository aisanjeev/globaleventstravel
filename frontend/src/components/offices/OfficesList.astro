---
import OfficeCard from './OfficeCard.astro';
import { officesApi } from '@/lib/api';
import type { Office } from '@/lib/types';
import { OFFICES } from '@/lib/data';

interface Props {
  showTitle?: boolean;
}

const { showTitle = true } = Astro.props;

let offices: Office[] = [];

try {
  offices = await officesApi.list();
} catch (error) {
  console.error('Failed to fetch offices from API, falling back to static data:', error);
  offices = OFFICES;
}
---

<section class="section bg-neutral-50">
  <div class="container-custom">
    {showTitle && (
      <div class="text-center mb-12">
        <span class="inline-block px-4 py-1.5 bg-primary-100 text-primary-700 rounded-full text-sm font-medium mb-4">
          Visit Us
        </span>
        <h2 class="text-3xl md:text-4xl font-bold text-secondary-600 mb-4">
          Our Offices
        </h2>
        <p class="text-lg text-neutral-600 max-w-2xl mx-auto">
          With multiple locations across India, we're always close to help you plan your next adventure.
        </p>
      </div>
    )}

    <!-- View Toggle -->
    <div class="flex justify-center mb-8">
      <div class="inline-flex bg-white rounded-lg border border-neutral-200 p-1">
        <button
          id="grid-view-btn"
          class="view-toggle-btn px-4 py-2 rounded-md text-sm font-medium bg-primary-500 text-white transition-colors"
          data-view="grid"
        >
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
            </svg>
            All Offices
          </span>
        </button>
        <button
          id="tabs-view-btn"
          class="view-toggle-btn px-4 py-2 rounded-md text-sm font-medium text-neutral-600 hover:text-neutral-900 transition-colors"
          data-view="tabs"
        >
          <span class="flex items-center gap-2">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
            One at a Time
          </span>
        </button>
      </div>
    </div>

    <!-- Grid View -->
    <div id="grid-view" class="grid grid-cols-1 md:grid-cols-2 gap-6">
      {offices.map((office) => (
        <OfficeCard office={office} />
      ))}
    </div>

    <!-- Tabs View (Hidden by default) -->
    <div id="tabs-view" class="hidden">
      <!-- Tab Navigation -->
      <div class="flex flex-wrap justify-center gap-2 mb-6">
        {offices.map((office, index) => (
          <button
            class={`office-tab-btn px-4 py-2 rounded-full text-sm font-medium transition-colors ${
              index === 0 
                ? 'bg-primary-500 text-white' 
                : 'bg-white text-neutral-600 border border-neutral-200 hover:border-primary-300'
            }`}
            data-office-id={office.id}
          >
            {office.city}
          </button>
        ))}
      </div>

      <!-- Tab Content -->
      <div class="max-w-2xl mx-auto">
        {offices.map((office, index) => (
          <div
            class={`office-tab-content ${index === 0 ? '' : 'hidden'}`}
            data-office-id={office.id}
          >
            <OfficeCard office={office} />
          </div>
        ))}
      </div>
    </div>
  </div>
</section>

<script>
  // View Toggle
  const gridViewBtn = document.getElementById('grid-view-btn');
  const tabsViewBtn = document.getElementById('tabs-view-btn');
  const gridView = document.getElementById('grid-view');
  const tabsView = document.getElementById('tabs-view');

  gridViewBtn?.addEventListener('click', () => {
    gridView?.classList.remove('hidden');
    tabsView?.classList.add('hidden');
    gridViewBtn.classList.add('bg-primary-500', 'text-white');
    gridViewBtn.classList.remove('text-neutral-600');
    tabsViewBtn?.classList.remove('bg-primary-500', 'text-white');
    tabsViewBtn?.classList.add('text-neutral-600');
  });

  tabsViewBtn?.addEventListener('click', () => {
    gridView?.classList.add('hidden');
    tabsView?.classList.remove('hidden');
    tabsViewBtn.classList.add('bg-primary-500', 'text-white');
    tabsViewBtn.classList.remove('text-neutral-600');
    gridViewBtn?.classList.remove('bg-primary-500', 'text-white');
    gridViewBtn?.classList.add('text-neutral-600');
  });

  // Tab Navigation
  const tabBtns = document.querySelectorAll('.office-tab-btn');
  const tabContents = document.querySelectorAll('.office-tab-content');

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      const officeId = btn.getAttribute('data-office-id');
      
      // Update button styles
      tabBtns.forEach(b => {
        b.classList.remove('bg-primary-500', 'text-white');
        b.classList.add('bg-white', 'text-neutral-600', 'border', 'border-neutral-200');
      });
      btn.classList.add('bg-primary-500', 'text-white');
      btn.classList.remove('bg-white', 'text-neutral-600', 'border', 'border-neutral-200');
      
      // Show/hide content
      tabContents.forEach(content => {
        if (content.getAttribute('data-office-id') === officeId) {
          content.classList.remove('hidden');
        } else {
          content.classList.add('hidden');
        }
      });
    });
  });
</script>

